name: "C++ CI/CD"

on:
  push:
    branches:
      - main

jobs:
  bump_version:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
      major: ${{ steps.bump.outputs.major }}
      minor: ${{ steps.bump.outputs.minor }}
      patch: ${{ steps.bump.outputs.patch }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Bump version
        id: bump
        run: |
          git fetch --tags --quiet
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "1.0.0")
          last_tag=${last_tag#v}
          IFS='.' read -r major minor patch <<< "$last_tag"
          while true; do
            patch=$((patch+1))
            new_tag="$major.$minor.$patch"
            if git rev-parse -q --verify "refs/tags/$new_tag" >/dev/null 2>&1; then
              continue
            fi
            git tag "$new_tag"
            git push origin "refs/tags/$new_tag"
            echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
            echo "major=$major" >> "$GITHUB_OUTPUT"
            echo "minor=$minor" >> "$GITHUB_OUTPUT"
            echo "patch=$patch" >> "$GITHUB_OUTPUT"
            break
          done

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    needs: bump_version
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Install dependencies on Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libsfml-dev zip git

      - name: Install dependencies on Windows
        if: runner.os == 'Windows'
        run: |
          choco install mingw
          choco install cmake
          choco install git

      - name: Configure & Build
        run: |
          cmake -S . -B build -DPATCH_VERSION=${{ github.run_number }}
          cmake --build build --config Release

      - name: Archive Build
        run: |
          cd build
          zip -r ../${{ runner.os }}-build.zip *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-build
          path: ${{ runner.os }}-build.zip

  release:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./release_files

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./release_files

      - name: Create GitHub Release & Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release 1.0.${{ github.run_number }}
          files: ./release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
